# ARG BASE_REGISTRY=registry1.dso.mil
# ARG BASE_IMAGE=ironbank/opensource/nodejs/nodejs18
# ARG BASE_TAG=18.19.0-slim 

# FROM ${BASE_REGISTRY}/${BASE_IMAGE}:${BASE_TAG}


FROM node:21.6.1-slim
# `nonroot` user 
# USER 65532:65532

WORKDIR /app

# Unzip the tar.gz file
# RUN tar -xzf /tmp/pepr.tgz . && \
#     mv pepr-* pepr && \
#     mv pepr/* . 

    
# Copy the node config files
COPY --chown=node:node . .

# Load only direct dependencies for Production use
RUN npm ci && \
    npm run build && \
    # Clean up npm cache
    npm cache clean --force && \
    # Remove @types
    rm -fr node_modules/@types && \
    # Remove Ramda unused Ramda files
    rm -fr node_modules/ramda/dist && \
    rm -fr node_modules/ramda/es && \
    # Remove all typescript files
    find . -name "*.ts" -type f -delete

COPY --chown=node:node . .

RUN npm run build
# RUN    ls -la
# # Sync the pepr dist files
COPY --chown=node:node . .
# COPY --chown=node:node ./dist/  ./node_modules/pepr/dist/
# COPY --chown=node:node ./package.json  ./node_modules/pepr/package.json
